#!/usr/bin/env bash

# All this is language compiler logic that requires compiling to binary.
# This logic is very important so that the compiled language can run very fast.
# If there is another language and you need another compiler, you can add it here and then call the function.

# Logic core compiler
compile_modules() {
    local BASE_PATH
    BASE_PATH="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"

    if [ -d "$BASE_PATH" ]; then
        cd "$BASE_PATH" || return 1
    fi

    # --- ALL GOLANG IN ALL PROJECTS ---
    if command -v go > /dev/null; then
        [ -f "go.mod" ] && rm go.mod

        echo -e "[✓] Compile Go is executed!"
        go mod init github.com/storm-os/storm-framework

        echo -e "[*] Syncing dependencies."
        go get github.com/google/gopacket@latest
        go get github.com/google/gopacket/pcap@latest
        go mod tidy

        find . -name "*.go" -not -path "*/.*" -not -path "*/vendor/*" | while read -r src; do
            output="${src%.go}"
            CGO_ENABLED=1 go build -mod=mod -o "$output" "$src"
            chmod +x "$output"
        echo -e "[✓] Compiled Go success!" 
        done
    fi

    # --- ALL C's IN THE WHOLE PROJECT ---
    if command -v gcc > /dev/null; then
        echo -e "[✓] Compile C is executed!"

        find . -name "*.c" -not -path "*/.*" | while read -r src; do
            output="${src%.c}"
            if grep -q "pcap.h" "$src"; then
                gcc "$src" -o "$output" -lpcap
            else
                gcc "$src" -o "$output"
            fi
            chmod +x "$output"
        echo -e "[✓] Compiled C success!"
        done
    fi

    # --- AUTOMATIC RUST DISCOVERY ---
    if command -v cargo > /dev/null; then
        echo -e "[✓] Compile Rust is executed!"

        find . -name "*.rs" -not -path "*/.*" | while read -r src; do
            output_dir="$(dirname "$src")"
            output_name="$(basename "$src" .rs)"

            (
                cd "$output_dir" || exit
                cargo build --release --quiet

                if [ -f "target/release/$output_name" ]; then
                    cp "target/release/$output_name" "./$output_name"
                    chmod +x "$output_name"
                    
                    rm -rf target Cargo.lock
                fi
            )
        echo -e "[✓] Compiled Rust success!"
        done
    fi

}

