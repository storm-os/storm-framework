#!/usr/bin/env bash

# --- CONFIGURATION ---
TOOL_NAME="pentest"
REPO_NAME="storm-framework"
GITHUB_REPO="https://github.com/storm-os/$REPO_NAME.git"
VERSION=$(curl -s https://raw.githubusercontent.com/storm-os/storm-framework/main/version.txt)

# Warna
GREEN='\033[92m'
RED='\033[91m'
BLUE='\033[94m'
NC='\033[0m'

write_to_file() {
    local content=$1
    local file=$2
    local append=$3

    if $NEEDS_SUDO; then
        if [ "$append" = true ]; then
            echo "$content" | sudo tee -a "$file" > /dev/null
        else
            echo "$content" | sudo tee "$file" > /dev/null
        fi
    else
        if [ "$append" = true ]; then
            echo "$content" >> "$file"
        else
            echo "$content" > "$file"
        fi
    fi
}

# -----------------------------------------------------------------------------
# --- AUTOMATIC ENVIRONMENT DETECTION & PATH CONFIGURATION ---
# -----------------------------------------------------------------------------
if [ -d "/data/data/com.termux" ]; then
    # Termux Environment
    echo -e "${GREEN}[!] Environment detected: Termux${NC}"

    BIN_DIR="$PREFIX/bin"
    SHEBANG_PATH="#!$PREFIX/bin/bash"
    PYTHON_CMD="python"
    INSTALL_DIR="$PREFIX/share/$REPO_NAME"

    NEEDS_SUDO=false
    pkg install -y python git golang build-essential libpcap clang ffmpeg openssl
else
    # Standard Linux Environment
    echo -e "${GREEN}[!] Environment detected: Standard Linux${NC}"

    BIN_DIR="/usr/local/bin"
    SHEBANG_PATH="#!/bin/bash"
    PYTHON_CMD="python3"
    INSTALL_DIR="/opt/$REPO_NAME"

    NEEDS_SUDO=true
    sudo apt install -y python3 python3-pip git golang build-essential libpcap-dev clang ffmpeg openssl
fi

# -----------------------------------------------------------------------------

echo -e "${GREEN}[!] Start Installation: ${REPO_NAME} [!] ${NC}"

# 1. Check Python and Git
if ! command -v git &> /dev/null; then
    echo -e "${RED}[x] ERROR: Git not found. Install Git first.${NC}"
    exit 1
fi
if ! command -v "$PYTHON_CMD" &> /dev/null; then
    echo -e "${RED}[x] ERROR: Python not found. Make sure $PYTHON_CMD installed.${NC}"
    exit 1
fi

# 2. Installation Directory Preparation
if [ -d "$INSTALL_DIR" ]; then
    echo -e "${GREEN}[-] Remove old installations.${NC}"
    cd ~
    if $NEEDS_SUDO; then sudo rm -rf "$INSTALL_DIR"; else rm -rf "$INSTALL_DIR"; fi
fi

echo -e "${GREEN}[+] Create installation directory"

# Creating a directory and cloning a repository (use sudo if necessary)
if $NEEDS_SUDO; then
    sudo mkdir -p "$INSTALL_DIR"
    sudo git clone "$GITHUB_REPO" "$INSTALL_DIR"
else
    mkdir -p "$INSTALL_DIR"
    git clone "$GITHUB_REPO" "$INSTALL_DIR"
fi


if [ $? -ne 0 ]; then
    echo -e "${RED}[x] ERROR: Failed to clone repository. Check URL GitHub.${NC}"
    if $NEEDS_SUDO; then sudo rm -rf "$INSTALL_DIR"; else rm -rf "$INSTALL_DIR"; fi
    exit 1
fi

# 3. Install Python Dependencies
if [ -f "$INSTALL_DIR/requirements.txt" ]; then
    echo -e "${GREEN}[+] Installing Python dependencies.${NC}"

    if $NEEDS_SUDO; then
        # In Ubuntu/Kali, we add the flag --break-system-packages
        sudo "$PYTHON_CMD" -m pip install -r "$INSTALL_DIR/requirements.txt" --break-system-packages
    else
        # In Termux, pip usually doesn't need additional flags.
        "$PYTHON_CMD" -m pip install -r "$INSTALL_DIR/requirements.txt"
    fi

    if [ $? -ne 0 ]; then
        echo -e "${RED}[x] ERROR: Failed to install Python dependencies.${NC}"
        # Optional: Don't immediately exit if it fails, just give a warning.
    fi
fi

# 4. Run binary compilation
if [ -d "$INSTALL_DIR" ]; then
    cd "$INSTALL_DIR" || { echo -e "${RED}[x] ERROR: Cannot access $INSTALL_DIR${NC}"; }
fi

COMPILER_SRC="./compiler"

if [ -f "$COMPILER_SRC" ]; then
    echo -e "[*] Run binary compilation."
    . "$COMPILER_SRC"
    compile_modules
else
    echo -e "${RED}[x] ERROR: File compiler not found in $(pwd)!"
    echo -e "${RED}[!] Make sure the file exists in the project directory."
fi

# --- Security Identity Generation (Version: The 60-Char Fix) ---
if [ ! -f .env ]; then
    echo -e "[+] Generating unique security keys via OpenSSL..."

    # Generate Private Key
    PRIV_KEY=$(openssl genpkey -algorithm ed25519 2>/dev/null | openssl pkey -outform DER 2>/dev/null | base64 -w 0 | tr -d '[:space:]')

    # Generate Public Key
    PUB_KEY=$(echo -n "$PRIV_KEY" | base64 -d | openssl pkey -inform DER -pubout -outform DER 2>/dev/null | base64 -w 0 | tr -d '[:space:]')

    # This code just adds '=' when PUBKEY is only 59 characters long
    # Rust with its dependencies is very sensitive, it doesn't want anything odd.
    # Storm's security logic is written in Rust, and this Key is to make it run.
    if [ ${#PUB_KEY} -eq 59 ]; then
        PUB_KEY="${PUB_KEY}="
    fi

    # This code will insert the key into .env
    # This is very crucial because if there is only 1 space it will not be usable.
    write_to_file "STORM_PRIVKEY=${PRIV_KEY}" ".env" false
    write_to_file "STORM_PUBKEY=${PUB_KEY}" ".env" true

    echo -e "[✓] Security identity created successfully."
fi

# This ensures that the command always matches the environment.
if $NEEDS_SUDO; then
    sudo chmod 600 .env
    sudo python3 -m scripts.security.sign
else
    chmod 600 .env
    python3 -m scripts.security.sign
fi


# 5. Creating a Dynamic Wrapper Script
WRAPPER_DST="$BIN_DIR/$TOOL_NAME"

echo -e "[+] Creating a wrapper script: ${TOOL_NAME}"

# Create wrapper content in variables for easy management
CREATE_WRAPPER="${SHEBANG_PATH}
PROJECT_DIR=\"$INSTALL_DIR\"
cd \"\$PROJECT_DIR\" || { echo \"[x] ERROR: Failed to access project directory.\"; exit 1; }
exec ./storm \"\$@\""

write_to_file "$CREATE_WRAPPER" "$WRAPPER_DST" false

# Execute file creation based on access rights (Sudo vs User)
if $NEEDS_SUDO; then
    sudo chmod +x "$WRAPPER_DST"
else
    chmod +x "$WRAPPER_DST"
fi

echo -e "${GREEN}####################################################${NC}"
echo -e "${GREEN}[✓] PATH STORM: ${INSTALL_DIR}${NC}"
echo -e "${GREEN}[✓] PATH WRAPPER: ${BIN_DIR}/${TOOL_NAME}${NC}"
echo -e "${GREEN}[✓] INSTALLATION COMPLETE VERSION: ${VERSION}${NC}"
echo -e "${GREEN}####################################################${NC}"

