import requests
import time
import json

# --- Pengecekan Facebook ---
def check_facebook_email(email, C):
    """
    Mengirim permintaan POST ke endpoint identifikasi Facebook.
    """
    url = "https://www.facebook.com/login/identify/?ctx=recover"
    payload = {'email': email}
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Referer': url,
    }
    
    try:
        response = requests.post(url, data=payload, headers=headers, timeout=10)
        response_text = response.text.lower()
        
        failure_strings = ["find your account", "temukan akun anda", "no search results"]
        is_registered = not any(fs in response_text for fs in failure_strings)
        
        if is_registered:
            return C["SUCCESS"] + f"‚úÖ DITEMUKAN (Facebook): {email}" + C["RESET"]
        else:
            return C["ERROR"] + f"‚ùå TIDAK DITEMUKAN (Facebook): {email}" + C["RESET"]
            
    except requests.exceptions.RequestException as e:
        return C["ERROR"] + f"üö® ERROR Koneksi/Timeout (Facebook): {e}" + C["RESET"]
    except Exception as e:
        return C["ERROR"] + f"üö® ERROR tak terduga (Facebook): {e}" + C["RESET"]


# --- Pengecekan Instagram (Diadaptasi dari Kode Java) ---
def check_instagram_email(email, C):
    """
    Mengirim permintaan POST ke endpoint recovery Instagram yang lebih sederhana, 
    meniru logika kode Java yang sukses.
    """
    url = "https://www.instagram.com/accounts/account_recovery_send_ajax/"
    
    # Payload yang dikirimkan
    payload = {
        'email_or_username': email,
    }
    
    # Header minimal yang berhasil di Java
    headers = {
        # Menggunakan User-Agent yang sama seperti kode lain
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'X-CSRFToken': 'missing', # Meniru penggunaan token 'missing' dari Java
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded', # Penting untuk POST form-encoded
        'Referer': 'https://www.instagram.com/', # Referer yang minimal
    }
    
    try:
        # Kirim POST request satu langkah
        response = requests.post(url, data=payload, headers=headers, timeout=10)
        
        # Logika Kunci: Cek String 'No users found' (atau varian lain)
        response_text = response.text
        
        # Logika Kunci Kegagalan (seperti di kode Java Anda):
        if "No users found" in response_text or "No user found" in response_text:
            return C["ERROR"] + f"‚ùå TIDAK DITEMUKAN (Instagram): {email}" + C["RESET"]
        
        # Logika Kunci Keberhasilan:
        # Jika bukan pesan kegagalan, dan kode respons 200 (atau 400 jika Instagram mengembalikan JSON error)
        # Kita cek string yang mengindikasikan keberhasilan, misalnya 'success' atau tidak adanya error.
        # Jika server mengembalikan JSON dan tidak ada pesan 'No users found' di dalamnya
        elif response.status_code == 200 or response.status_code == 400:
             # Jika response adalah JSON, kita bisa cek kunci tertentu
             try:
                 data = response.json()
                 if data.get('status') == 'ok' or data.get('error_type') is None:
                    return C["SUCCESS"] + f"‚úÖ DITEMUKAN (Instagram): {email}" + C["RESET"]
             except json.JSONDecodeError:
                 # Jika bukan JSON, dan tidak ada "No users found"
                 if response.status_code == 200:
                     return C["SUCCESS"] + f"‚úÖ DITEMUKAN (Instagram): {email}" + C["RESET"]
                 pass # Lanjut ke Error jika tidak yakin

        # Jika masih ada blokir
        return C["ERROR"] + f"üö® ERROR: Respons tidak terduga/Diblokir oleh Instagram." + C["RESET"]
            
    except requests.exceptions.RequestException as e:
        return C["ERROR"] + f"üö® ERROR Koneksi/Timeout (Instagram): {e}" + C["RESET"]
    except Exception as e:
        return C["ERROR"] + f"üö® ERROR tak terduga (Instagram): {e}" + C["RESET"]



# --- Fungsi Utama Runner (Diperbaiki) ---
def run_osint(email, C): # <--- HANYA MENERIMA 1 EMAIL STRING
    """
    Fungsi utama untuk menjalankan pengecekan email tunggal di berbagai platform.
    """
    email_clean = email.strip()
    
    print(C["HEADER"] + "\n--- OSINT MULTI-PLATFORM EMAIL CHECKER ---" + C["RESET"])
    
    if not email_clean:
        print(C["ERROR"] + "[-] ERROR: Email kosong.")
        print(C["HEADER"] + "------------------------------------------" + C["RESET"])
        return

    # Pemisah visual
    print(C["MENU"] + f"\n===== MEMERIKSA {email_clean} =====" + C["RESET"])
    
    # 1. Jalankan Pengecekan Facebook
    print(C["MENU"] + f"[*] Memeriksa Facebook..." + C["RESET"])
    result_fb = check_facebook_email(email_clean, C)
    print(result_fb)

    # 2. Jalankan Pengecekan Instagram
    print(C["MENU"] + f"[*] Memeriksa Instagram..." + C["RESET"])
    result_ig = check_instagram_email(email_clean, C)
    print(result_ig)
    
    # TIDAK ADA JEDA YANG DIPERLUKAN KARENA HANYA 1 EMAIL
        
    print(C["HEADER"] + "\n------------------------------------------" + C["RESET"])
