#!/usr/bin/env python3

# All import
import os
import time
import sys
import readline  # noqa: F401
import app.base.config_ui as config_ui
import app.utility.verify as r

from app.base.config_update import check_update
from app.utility.colors import C
from app.banners.banner import get_random_banner

from lib.core import handler

def clear_screen():
    """Clearing the terminal screen"""
    # Win Function
    if os.name == 'nt':
       os.system('cls')
    # Linux Functions
    else:
       os.system('clear')

# --- Menu Functions ---

def main():
    r.check_critical_files()
    r.run_verif()
    for i in range(6, 0, -1):
        sys.stdout.write(f"\r{C.SUCCESS}[*] Verification Success! Start Storm:{i} {C.RESET}")
        sys.stdout.flush()
        time.sleep(1)

    clear_screen()
    print(get_random_banner())
    config_ui.stormUI()
    check_update()

    current_module = None
    current_module_name = ""

    options = {
        "IP": "",
        "PORT": "",
        "PASS": "",
        "URL": "",
        "EMAIL": "",
        "HASH": "",
        "MESSAGE": "",
        "USER": "",
        "ID": "",
        "COUNT": "",
        "PATH": "",
        "INTERFACE": "",
        "THREAD": "",
        "DOMAIN": "",
        "HOSTNAME": ""
    }
    while True:
        START_INV = "\001"
        END_INV = "\002"

        C_INPUT_INV = f"{START_INV}{C.INPUT}{END_INV}"
        C_ERROR_INV = f"{START_INV}{C.ERROR}{END_INV}"
        C_RESET_INV = f"{START_INV}{C.RESET}{END_INV}"

        p_mod = f"({C_ERROR_INV}{current_module_name}{C_INPUT_INV})" if current_module else ""
        try:
            print()
            promp = f"{C_INPUT_INV}[~]{p_mod}==> {C_RESET_INV}"
            user_input = input(promp).strip().split()
            print()
        except EOFError: break

        if not user_input: continue

        cmd = user_input[0].lower()
        args = user_input[1:]

        # Wrap all data into Context
        context = {
            "current_module": current_module,
            "current_module_name": current_module_name,
            "options": options,
            "exit": False
        }

        # HAND IT OVER TO THE FOREMAN (HANDLER)
        new_context = handler.execute(cmd, args, context)

        if new_context:
            current_module = new_context["current_module"]
            current_module_name = new_context["current_module_name"]
            options = new_context["options"]

            if new_context.get("exit"): break
        else:
            print(f"[-] Unknown Command: {cmd}. Run the {C.SUCCESS}help{C.RESET} {C.INPUT}command for more details.")

if __name__ == "__main__":
    main()
